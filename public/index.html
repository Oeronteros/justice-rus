<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cult Game Community — Justice Mobile</title>
  
  <!-- Tailwind CSS через CDN для тестирования (замени на /output.css после build) -->
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Подключаем конфиг -->
  <script src="/config.js"></script>
  
  <style>
    #pinScreen {
      transition: opacity 0.3s ease-in-out;
    }
    @media (max-width: 640px) {
      nav {
        flex-direction: column;
        gap: 2px;
      }
      .nav-btn {
        width: 100%;
      }
    }
    .nav-btn {
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }
    .nav-btn:hover {
      border-color: rgba(239, 68, 68, 0.3);
      transform: translateY(-1px);
    }
    .nav-btn.active {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(139, 92, 246, 0.2));
      border-color: rgba(239, 68, 68, 0.5);
    }
    table th {
      font-weight: 600;
      color: #d1d5db;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }
    table td, table th {
      padding: 0.75rem 1rem;
    }
    .status-pending { background-color: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .status-active { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .status-inactive { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }
    .status-leave { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .level-novice { background: linear-gradient(135deg, #6b7280, #374151); }
    .level-member { background: linear-gradient(135deg, #059669, #047857); }
    .level-veteran { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
    .level-elite { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
    .level-legend { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .level-gm { background: linear-gradient(135deg, #dc2626, #b91c1c); }
    .kpi-good { color: #4ade80; }
    .kpi-medium { color: #fbbf24; }
    .kpi-bad { color: #f87171; }
    .growth-positive { color: #4ade80; }
    .growth-negative { color: #f87171; }
    .activity-category { 
      border-left: 4px solid;
      padding-left: 12px;
    }
    .activity-pve { border-color: #10b981; }
    .activity-pvp { border-color: #ef4444; }
    .activity-event { border-color: #8b5cf6; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- BACKGROUND VIDEO -->
<video autoplay muted loop playsinline class="fixed inset-0 w-full h-full object-cover z-0 opacity-50" id="backgroundVideo">
  <source src="videos/background.mp4" type="video/mp4">
</video>
<div class="fixed inset-0 bg-black/70 z-0"></div>

<!-- PIN ACCESS SCREEN -->
<div id="pinScreen" class="fixed inset-0 flex items-center justify-center z-50 bg-black/90">
  <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full">
    <h1 class="text-2xl font-bold mb-4 text-center">Вход в Cult Community</h1>
    <input type="password" id="pinInput" class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded" placeholder="Введите PIN">
    <button id="pinBtn" class="w-full bg-red-600 hover:bg-red-700 p-3 rounded font-bold">Войти</button>
    <p id="pinError" class="text-red-500 mt-2 hidden">Неверный PIN. Попробуйте снова.</p>
  </div>
</div>

<!-- SITE HEADER -->
<header id="siteHeader" class="bg-gray-900/95 backdrop-blur-lg shadow-lg sticky top-0 z-40 hidden flex items-center justify-between px-4 py-3">
  <div class="flex items-center space-x-4">
    <h1 class="text-xl font-bold">Demonic Cult Portal</h1>
    <nav class="flex space-x-2">
      <button id="navMembers" class="nav-btn px-4 py-2 rounded bg-gray-800 hover:bg-gray-700">Участники</button>
      <button id="navActivity" class="nav-btn px-4 py-2 rounded bg-gray-800 hover:bg-gray-700">Активность</button>
      <button id="navHelp" class="nav-btn px-4 py-2 rounded bg-gray-800 hover:bg-gray-700">Помощь</button>
      <button id="navNews" class="nav-btn px-4 py-2 rounded bg-gray-800 hover:bg-gray-700">Новости</button>
      <button id="navGuides" class="nav-btn px-4 py-2 rounded bg-gray-800 hover:bg-gray-700">Гайды</button>
    </nav>
  </div>
  <div class="flex items-center space-x-4">
    <select id="langSwitch" class="bg-gray-700 p-2 rounded">
      <option value="ru">RU</option>
      <option value="en">EN</option>
    </select>
    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 p-2 rounded"><i class="fas fa-sync"></i></button>
  </div>
</header>

<!-- MAIN CONTENT -->
<main id="mainContent" class="max-w-7xl mx-auto px-4 py-6 relative z-20 hidden">
  <!-- Раздел Участники -->
  <section id="members" class="hidden">
    <h2 class="text-2xl font-bold mb-4">Участники</h2>
    <table class="w-full bg-gray-800 rounded-lg overflow-hidden">
      <thead>
        <tr>
          <th>Имя</th>
          <th>Уровень</th>
          <th>Статус</th>
        </tr>
      </thead>
      <tbody id="membersTableBody"></tbody>
    </table>
  </section>

  <!-- Раздел Активность -->
  <section id="activity" class="hidden">
    <h2 class="text-2xl font-bold mb-4">Активность</h2>
    <div id="activityList"></div>
  </section>

  <!-- Раздел Помощь -->
  <section id="help" class="hidden">
    <h2 class="text-2xl font-bold mb-4">Помощь</h2>
  </section>

  <!-- Раздел Новости -->
  <section id="news" class="hidden">
    <h2 class="text-2xl font-bold mb-4">Новости</h2>
    <div id="newsList"></div>
  </section>

  <!-- Раздел Гайды -->
  <section id="guides" class="hidden">
    <h2 class="text-2xl font-bold mb-4">Гайды</h2>
    <select id="guideCategoryFilter" class="mb-4 bg-gray-700 p-2 rounded">
      <option value="all">Все</option>
    </select>
    <div id="guidesList"></div>
  </section>
</main>

<script>
// === ФУНКЦИИ ЗАГРУЗКИ ДАННЫХ ===
async function loadData(sheetName) {
  try {
    const url = `${CONFIG.API.GOOGLE_SHEETS_PROXY}?sheet=${sheetName}&id=${CONFIG.SHEET_ID}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error('Error loading data');
    return await response.json();
  } catch (error) {
    console.error('Load data error:', error);
    return [];
  }
}

// === ПРОВЕРКА PIN ===
async function checkPin() {
  const pin = document.getElementById('pinInput').value;
  if (!pin) return;

  try {
    const response = await fetch('/api/check-pin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pin })
    });

    if (!response.ok) {
      throw new Error('Invalid PIN');
    }

    const { role } = await response.json();
    localStorage.setItem('userRole', role);

    const pinScreen = document.getElementById('pinScreen');
    pinScreen.style.opacity = '0';
    setTimeout(() => {
      pinScreen.style.display = 'none';
      document.getElementById('siteHeader').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'block';
      showSection('members');
    }, 300);
  } catch (error) {
    document.getElementById('pinError').style.display = 'block';
    document.getElementById('pinInput').value = '';
  }
}

// === ПЕРЕКЛЮЧЕНИЕ ВИДЕО ===
function toggleBackgroundVideo() {
  const video = document.getElementById('backgroundVideo');
  if (window.innerWidth < 768) {
    video.pause();
    video.src = '';
  } else {
    video.src = 'videos/background.mp4';
    video.play();
  }
}

// === ПОКАЗ РАЗДЕЛА ===
function showSection(sectionId) {
  document.querySelectorAll('main > section').forEach(sec => sec.style.display = 'none');
  document.getElementById(sectionId).style.display = 'block';
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`nav${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`).classList.add('active');
  recordVisit(sectionId);
  if (sectionId === 'members') loadMembers();
  else if (sectionId === 'activity') loadActivity();
  else if (sectionId === 'help') loadHelp();
  else if (sectionId === 'news') loadNews();
  else if (sectionId === 'guides') loadGuides();
}

// === ЗАГРУЗКА УЧАСТНИКОВ ===
async function loadMembers() {
  const data = await loadData(CONFIG.SHEETS.members);
  const tbody = document.getElementById('membersTableBody');
  tbody.innerHTML = '';
  data.slice(1).forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row[0] || ''}</td>
      <td class="${CONFIG.LEVELS[row[1]?.toLowerCase() || 'novice'].color}">${CONFIG.LEVELS[row[1]?.toLowerCase() || 'novice'].name.ru}</td>
      <td class="status-${row[2]?.toLowerCase() || 'pending'}">${row[2] || ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

// === ЗАГРУЗКА АКТИВНОСТИ ===
async function loadActivity() {
  const data = await loadData(CONFIG.SHEETS.activity);
  const list = document.getElementById('activityList');
  list.innerHTML = '';
  data.slice(1).forEach(row => {
    const div = document.createElement('div');
    div.className = 'activity-category activity-pve';  // Адаптируй класс
    div.innerHTML = `<p>${row[0]} - ${row[1]}</p>`;
    list.appendChild(div);
  });
}

// === ЗАГРУЗКА ПОМОЩИ ===
async function loadHelp() {
  const data = await loadData(CONFIG.SHEETS.help);
  // Рендер помощи, пример
  const section = document.getElementById('help');
  section.innerHTML = '<h2 class="text-2xl font-bold mb-4">Помощь</h2>';
  data.slice(1).forEach(row => {
    const p = document.createElement('p');
    p.textContent = row[0];
    section.appendChild(p);
  });
}

// === ЗАГРУЗКА НОВОСТЕЙ ===
async function loadNews() {
  const data = await loadData(CONFIG.SHEETS.news);
  const list = document.getElementById('newsList');
  list.innerHTML = '';
  data.slice(1).forEach(row => {
    const div = document.createElement('div');
    div.innerHTML = `<h3>${row[0]}</h3><p>${row[1]}</p>`;
    list.appendChild(div);
  });
}

// === ЗАГРУЗКА ГАЙДОВ ===
async function loadGuides() {
  const data = await loadData(CONFIG.SHEETS.guides);
  renderGuides(data);
}

// === РЕНДЕР ГАЙДОВ ===
function renderGuides(data) {
  const filter = document.getElementById('guideCategoryFilter').value;
  const list = document.getElementById('guidesList');
  list.innerHTML = '';
  data.slice(1).forEach(row => {
    if (filter === 'all' || row[0] === filter) {
      const div = document.createElement('div');
      div.innerHTML = `<h3>${row[1]}</h3><p>${row[2]}</p>`;
      list.appendChild(div);
    }
  });
}

// === СМЕНА ЯЗЫКА ===
function applyLanguage(lang) {
  currentLang = lang;
  document.documentElement.lang = lang;
  
  // Обновляем все элементы с data атрибутами
  document.querySelectorAll('[data-ru]').forEach(el => {
    const text = el.dataset[lang];
    if (text) el.textContent = text;
  });
  
  // Обновляем отображение роли
  const roleDisplay = document.getElementById('currentRole');
  if (roleDisplay) {
    roleDisplay.textContent = CONFIG.ROLE_NAMES[currentRole][lang];
  }
  
  // Обновляем язык в селекторе
  document.getElementById('langSwitch').value = lang;
  
  // Обновляем опции фильтра категорий
  const filter = document.getElementById('guideCategoryFilter');
  if (filter) {
    Array.from(filter.options).forEach(option => {
      const text = option.dataset[lang];
      if (text) option.textContent = text;
    });
  }
}

function refreshAllData() {
  // Очищаем кэш
  dataCache = {};
  const refreshBtn = document.getElementById('refreshBtn');
  refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  refreshBtn.disabled = true;
  
  // Перезагружаем текущую секцию
  loadSectionData(currentSection).finally(() => {
    setTimeout(() => {
      refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
      refreshBtn.disabled = false;
    }, 500);
  });
}

function refreshGuides() {
  if (dataCache['guides']) {
    delete dataCache['guides'];
  }
  renderGuides();
}

// ===== МОДАЛЬНЫЕ ОКНА =====
function openCreateGuideModal() {
  document.getElementById('createGuideModal').classList.remove('hidden');
  document.getElementById('createGuideModal').classList.add('flex');
}

function closeCreateGuideModal() {
  document.getElementById('createGuideModal').classList.add('hidden');
  document.getElementById('createGuideModal').classList.remove('flex');
  document.getElementById('guideForm').reset();
}

function openNewHelpForm() {
  document.getElementById('newHelpForm').classList.remove('hidden');
}

function closeNewHelpForm() {
  document.getElementById('newHelpForm').classList.add('hidden');
  document.getElementById('activityType').value = '';
  document.getElementById('urgency').value = 'normal';
  document.getElementById('problemDescription').value = '';
}

function openAddEventModal() {
  // Устанавливаем текущую дату по умолчанию
  const today = new Date();
  const dateStr = today.toISOString().split('T')[0];
  document.getElementById('eventDate').value = dateStr;
  
  // Устанавливаем время по умолчанию (19:00)
  document.getElementById('eventTime').value = '19:00';
  
  document.getElementById('addEventModal').classList.remove('hidden');
  document.getElementById('addEventModal').classList.add('flex');
}

function closeAddEventModal() {
  document.getElementById('addEventModal').classList.add('hidden');
  document.getElementById('addEventModal').classList.remove('flex');
  document.getElementById('eventForm').reset();
}

// ===== ОБРАБОТКА ФОРМ =====
function submitGuideForm(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  
  // В реальном приложении здесь был бы запрос к Google Apps Script
  alert('Функция отправки гайда будет работать после настройки Google Apps Script');
  
  closeCreateGuideModal();
  // Обновляем список гайдов
  setTimeout(() => {
    if (dataCache['guides']) delete dataCache['guides'];
    renderGuides();
  }, 1000);
}

function submitHelpRequest() {
  const activity = document.getElementById('activityType').value;
  const urgency = document.getElementById('urgency').value;
  const description = document.getElementById('problemDescription').value;
  
  if (!activity || !description) {
    alert('Пожалуйста, заполните все обязательные поля');
    return;
  }
  
  // В реальном приложении здесь был бы запрос к Google Apps Script
  alert('Запрос помощи отправлен! В реальной версии он сохранится в Google Таблице');
  
  closeNewHelpForm();
  // Обновляем список запросов
  setTimeout(() => {
    if (dataCache['help']) delete dataCache['help'];
    renderHelp();
  }, 1000);
}

function submitEvent() {
  const date = document.getElementById('eventDate').value;
  const time = document.getElementById('eventTime').value;
  const title = document.getElementById('eventTitle').value;
  const type = document.getElementById('eventType').value;
  const description = document.getElementById('eventDescription').value;
  const organizer = document.getElementById('eventOrganizer').value;
  
  if (!date || !time || !title) {
    alert('Пожалуйста, заполните обязательные поля');
    return;
  }
  
  // В реальном приложении здесь был бы запрос к Google Apps Script
  alert('Событие добавлено! В реальной версии оно сохранится в Google Таблице');
  
  closeAddEventModal();
  // Обновляем расписание
  setTimeout(() => {
    if (dataCache['activity']) delete dataCache['activity'];
    renderActivity();
  }, 1000);
}

// ===== DISCORD СИНХРОНИЗАЦИЯ =====
function syncDiscordNews() {
  const button = document.querySelector('#news button[onclick*="syncDiscordNews"]');
  const originalHTML = button.innerHTML;
  
  button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Синхронизация...';
  button.disabled = true;
  
  // Имитация синхронизации
  setTimeout(() => {
    // Обновляем время последней синхронизации
    const timeEl = document.getElementById('lastSyncTime');
    if (timeEl) {
      timeEl.textContent = new Date().toLocaleTimeString('ru-RU', 
        { hour: '2-digit', minute: '2-digit', second: '2-digit' }
      );
    }
    
    button.innerHTML = originalHTML;
    button.disabled = false;
    
    // Обновляем новости
    if (dataCache['news']) delete dataCache['news'];
    renderNews();
    
    alert('Новости синхронизированы с Discord!');
  }, 1500);
}

// ===== СТАТИСТИКА =====
function recordVisit() {
  const stats = getStats();
  const now = new Date();
  const dateKey = now.toISOString().split('T')[0];
  const hour = now.getHours();
  
  // Обновляем статистику
  stats.totalVisits = (stats.totalVisits || 0) + 1;
  
  // Ежедневные посещения
  stats.dailyVisits = stats.dailyVisits || {};
  stats.dailyVisits[dateKey] = (stats.dailyVisits[dateKey] || 0) + 1;
  
  // Почасовые посещения
  stats.hourlyActivity = stats.hourlyActivity || {};
  stats.hourlyActivity[hour] = (stats.hourlyActivity[hour] || 0) + 1;
  
  // Сессии
  stats.sessions = stats.sessions || [];
  stats.sessions.push({
    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
    startTime: now.toISOString(),
    role: currentRole,
    section: currentSection
  });
  
  // Ограничиваем количество сессий
  if (stats.sessions.length > 100) {
    stats.sessions = stats.sessions.slice(-100);
  }
  
  saveStats(stats);
}

function getStats() {
  const statsJson = localStorage.getItem(CONFIG.STATS_KEY);
  return statsJson ? JSON.parse(statsJson) : {};
}

function saveStats(stats) {
  localStorage.setItem(CONFIG.STATS_KEY, JSON.stringify(stats));
}

function showAdminStats() {
  const stats = getStats();
  
  // Уникальные посетители (по уникальным session.id, approx)
  const uniqueVisitors = new Set(stats.sessions.map(s => s.id)).size;

  // Среднее время сессии
  let totalDuration = 0;
  let sessionCount = 0;
  stats.sessions.forEach(s => {
    if (s.endTime) {
      const duration = (new Date(s.endTime) - new Date(s.startTime)) / 1000 / 60;  // Минуты
      totalDuration += duration;
      sessionCount++;
    }
  });
  const avgTime = sessionCount > 0 ? (totalDuration / sessionCount).toFixed(1) + 'м' : 'N/A';

  // Самый активный день
  let maxDay = 'N/A';
  let maxVisits = 0;
  if (stats.dailyVisits) {
    Object.entries(stats.dailyVisits).forEach(([day, visits]) => {
      if (visits > maxVisits) {
        maxVisits = visits;
        maxDay = day;
      }
    });
  }

  const modalHtml = `
    <div id="adminStatsModal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
      <div class="bg-gray-900/95 backdrop-blur-xl p-6 rounded-2xl shadow-2xl w-full max-w-4xl border border-purple-700/50">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">Статистика посещаемости</h3>
          <button onclick="document.getElementById('adminStatsModal').remove()" class="text-gray-400 hover:text-white">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <div class="space-y-6">
          <div class="grid md:grid-cols-4 gap-4">
            <div class="bg-gray-800/50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-green-400">${stats.totalVisits || 0}</div>
              <div class="text-sm text-gray-400">Всего посещений</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-blue-400">${uniqueVisitors}</div>
              <div class="text-sm text-gray-400">Уникальных посетителей</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-yellow-400">${avgTime}</div>
              <div class="text-sm text-gray-400">Среднее время</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4 text-center">
              <div class="text-2xl font-bold text-purple-400">${maxDay}</div>
              <div class="text-sm text-gray-400">Самый активный день</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// ===== ИНИЦИАЛИЗАЦИЯ =====
document.addEventListener('DOMContentLoaded', () => {
  console.log("Сайт загружен!");
  
  // PIN input handling
  const pinInput = document.getElementById('pinInput');
  const pinBtn = document.getElementById('pinBtn');
  
  pinInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      checkPin();
    }
  });
  
  pinBtn.addEventListener('click', checkPin);
  
  // Navigation
  document.getElementById('navMembers').addEventListener('click', () => showSection('members'));
  document.getElementById('navActivity').addEventListener('click', () => showSection('activity'));
  document.getElementById('navHelp').addEventListener('click', () => showSection('help'));
  document.getElementById('navNews').addEventListener('click', () => showSection('news'));
  document.getElementById('navGuides').addEventListener('click', () => showSection('guides'));
  
  // Language switch
  document.getElementById('langSwitch').addEventListener('change', (e) => {
    applyLanguage(e.target.value);
  });
  
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', refreshAllData);
  
  // Guide category filter
  const categoryFilter = document.getElementById('guideCategoryFilter');
  if (categoryFilter) {
    categoryFilter.addEventListener('change', renderGuides);
  }
  
  // Focus PIN input on load
  pinInput.focus();
  toggleBackgroundVideo();
  window.addEventListener('resize', toggleBackgroundVideo);
  
  console.log("PIN система готова");
});

// Добавь end сессии
window.addEventListener('beforeunload', () => {
  const stats = getStats();
  const currentSession = stats.sessions[stats.sessions.length - 1];
  if (currentSession) {
    currentSession.endTime = new Date().toISOString();
    saveStats(stats);
  }
});
</script>
</body>
</html>